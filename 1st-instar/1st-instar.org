#+TITLE:  1st-instar of cicada-nymph
#+AUTHOR: 謝宇恆 / XIE Yuheng
#+EMAIL:  xyheme@gmail.com

* todo
* ===================================
* note notation
** jo & jojo
   * use "jo" to denote bead
     and use "jojo" to denote a thread of beads
     [which reads like "珠珠" in Chinese]
** naming convention in assembly code
   1. using underline to compose big word from small words
   2. using "$" as prefix and postfix separator
   3. for jo name
      * prefix "V__" for variable
** naming convention in cicada-nymph code
   1. for jo name
      [maybe]
      * borderfix "*" for variable
      * borderfix "+" for constant
* -----------------------------------
* prolog
** linux header
*** parameters order of syscall
    #+begin_src fasm :tangle 1st-instar.fasm
    define sys_6_r8  r8
    define sys_5_r9  r9
    define sys_4_r10 r10
    define sys_3_rdx rdx
    define sys_2_rsi rsi
    define sys_1_rdi rdi
    define sys_n_rax rax
    #+end_src
*** parameters order of function call
    #+begin_src fasm :tangle 1st-instar.fasm
    define fun_6_r9  r9
    define fun_5_r8  r8
    define fun_4_rcx rcx
    define fun_3_rdx rdx
    define fun_2_rsi rsi
    define fun_1_rdi rdi
    #+end_src
*** linux syscall numbers
    #+begin_src fasm :tangle 1st-instar.fasm
    ;; see /usr/include/asm/unistd_64.h (on archlinux)

    define syscall_read                      0
    define syscall_write                     1
    define syscall_open                      2
    define syscall_close                     3

    define syscall_stat                      4
    define syscall_fstat                     5
    define syscall_lstat                     6
    define syscall_poll                      7
    define syscall_lseek                     8
    define syscall_mmap                      9
    define syscall_mprotect                  10
    define syscall_munmap                    11
    define syscall_brk                       12
    define syscall_rt_sigaction              13
    define syscall_rt_sigprocmask            14
    define syscall_rt_sigreturn              15
    define syscall_ioctl                     16
    define syscall_pread64                   17
    define syscall_pwrite64                  18
    define syscall_readv                     19
    define syscall_writev                    20
    define syscall_access                    21
    define syscall_pipe                      22
    define syscall_select                    23
    define syscall_sched_yield               24
    define syscall_mremap                    25
    define syscall_msync                     26
    define syscall_mincore                   27
    define syscall_madvise                   28
    define syscall_shmget                    29
    define syscall_shmat                     30
    define syscall_shmctl                    31
    define syscall_dup2                      32
    define syscall_dup2                      33
    define syscall_pause                     34
    define syscall_nanosleep                 35
    define syscall_getitimer                 36
    define syscall_alarm                     37
    define syscall_setitimer                 38
    define syscall_getpid                    39
    define syscall_sendfile                  40
    define syscall_socket                    41
    define syscall_connect                   42
    define syscall_accept                    43
    define syscall_sendto                    44
    define syscall_recvfrom                  45
    define syscall_sendmsg                   46
    define syscall_recvmsg                   47
    define syscall_shutdown                  48
    define syscall_bind                      49
    define syscall_listen                    50
    define syscall_getsockname               51
    define syscall_getpeername               52
    define syscall_socketpair                53
    define syscall_setsockopt                54
    define syscall_getsockopt                55
    define syscall_clone                     56
    define syscall_fork                      57
    define syscall_vfork                     58
    define syscall_execve                    59

    define syscall_exit                      60

    define syscall_wait4                     61
    define syscall_kill                      62
    define syscall_uname                     63
    define syscall_semget                    64
    define syscall_semop                     65
    define syscall_semctl                    66
    define syscall_shmdt                     67
    define syscall_msgget                    68
    define syscall_msgsnd                    69
    define syscall_msgrcv                    70
    define syscall_msgctl                    71
    define syscall_fcntl                     72
    define syscall_flock                     73
    define syscall_fsync                     74
    define syscall_fdatasync                 75
    define syscall_truncate                  76
    define syscall_ftruncate                 77
    define syscall_getdents                  78
    define syscall_getcwd                    79
    define syscall_chdir                     80
    define syscall_fchdir                    81
    define syscall_rename                    82
    define syscall_mkdir                     83
    define syscall_rmdir                     84
    define syscall_creat                     85
    define syscall_link                      86
    define syscall_unlink                    87
    define syscall_symlink                   88
    define syscall_readlink                  89
    define syscall_chmod                     90
    define syscall_fchmod                    91
    define syscall_chown                     92
    define syscall_fchown                    93
    define syscall_lchown                    94
    define syscall_umask                     95
    define syscall_gettimeofday              96
    define syscall_getrlimit                 97
    define syscall_getrusage                 98
    define syscall_sysinfo                   99
    define syscall_times                     100
    define syscall_ptrace                    101
    define syscall_getuid                    102
    define syscall_syslog                    103
    define syscall_getgid                    104
    define syscall_setuid                    105
    define syscall_setgid                    106
    define syscall_geteuid                   107
    define syscall_getegid                   108
    define syscall_setpgid                   109
    define syscall_getppid                   110
    define syscall_getpgrp                   111
    define syscall_setsid                    112
    define syscall_setreuid                  113
    define syscall_setregid                  114
    define syscall_getgroups                 115
    define syscall_setgroups                 116
    define syscall_setresuid                 117
    define syscall_getresuid                 118
    define syscall_setresgid                 119
    define syscall_getresgid                 120
    define syscall_getpgid                   121
    define syscall_setfsuid                  122
    define syscall_setfsgid                  123
    define syscall_getsid                    124
    define syscall_capget                    125
    define syscall_capset                    126
    define syscall_rt_sigpending             127
    define syscall_rt_sigtimedwait           128
    define syscall_rt_sigqueueinfo           129
    define syscall_rt_sigsuspend             130
    define syscall_sigaltstack               131
    define syscall_utime                     132
    define syscall_mknod                     133
    define syscall_uselib                    134
    define syscall_personality               135
    define syscall_ustat                     136
    define syscall_statfs                    137
    define syscall_fstatfs                   138
    define syscall_sysfs                     139
    define syscall_getpriority               140
    define syscall_setpriority               141
    define syscall_sched_setparam            142
    define syscall_sched_getparam            143
    define syscall_sched_setscheduler        144
    define syscall_sched_getscheduler        145
    define syscall_sched_get_priority_max    146
    define syscall_sched_get_priority_min    147
    define syscall_sched_rr_get_interval     148
    define syscall_mlock                     149
    define syscall_munlock                   150
    define syscall_mlockall                  151
    define syscall_munlockall                152
    define syscall_vhangup                   153
    define syscall_modify_ldt                154
    define syscall_pivot_root                155
    define syscall__sysctl                   156
    define syscall_prctl                     157
    define syscall_arch_prctl                158
    define syscall_adjtimex                  159
    define syscall_setrlimit                 160
    define syscall_chroot                    161
    define syscall_sync                      162
    define syscall_acct                      163
    define syscall_settimeofday              164
    define syscall_mount                     165
    define syscall_umount2                   166
    define syscall_swapon                    167
    define syscall_swapoff                   168
    define syscall_reboot                    169
    define syscall_sethostname               170
    define syscall_setdomainname             171
    define syscall_iopl                      172
    define syscall_ioperm                    173
    define syscall_create_module             174
    define syscall_init_module               175
    define syscall_delete_module             176
    define syscall_get_kernel_syms           177
    define syscall_query_module              178
    define syscall_quotactl                  179
    define syscall_nfsservctl                180
    define syscall_getpmsg                   181
    define syscall_putpmsg                   182
    define syscall_afs_syscall               183
    define syscall_tuxcall                   184
    define syscall_security                  185
    define syscall_gettid                    186
    define syscall_readahead                 187
    define syscall_setxattr                  188
    define syscall_lsetxattr                 189
    define syscall_fsetxattr                 190
    define syscall_getxattr                  191
    define syscall_lgetxattr                 192
    define syscall_fgetxattr                 193
    define syscall_listxattr                 194
    define syscall_llistxattr                195
    define syscall_flistxattr                196
    define syscall_removexattr               197
    define syscall_lremovexattr              198
    define syscall_fremovexattr              199
    define syscall_tkill                     200
    define syscall_time                      201
    define syscall_futex                     202
    define syscall_sched_setaffinity         203
    define syscall_sched_getaffinity         204
    define syscall_set_thread_area           205
    define syscall_io_setup                  206
    define syscall_io_destroy                207
    define syscall_io_getevents              208
    define syscall_io_submit                 209
    define syscall_io_cancel                 210
    define syscall_get_thread_area           211
    define syscall_lookup_dcookie            212
    define syscall_epoll_create              213
    define syscall_epoll_ctl_old             214
    define syscall_epoll_wait_old            215
    define syscall_remap_file_pages          216
    define syscall_getdents64                217
    define syscall_set_tid_address           218
    define syscall_restart_syscall           219
    define syscall_semtimedop                220
    define syscall_fadvise64                 221
    define syscall_timer_create              222
    define syscall_timer_settime             223
    define syscall_timer_gettime             224
    define syscall_timer_getoverrun          225
    define syscall_timer_delete              226
    define syscall_clock_settime             227
    define syscall_clock_gettime             228
    define syscall_clock_getres              229
    define syscall_clock_nanosleep           230
    define syscall_exit_group                231
    define syscall_epoll_wait                232
    define syscall_epoll_ctl                 233
    define syscall_tgkill                    234
    define syscall_utimes                    235
    define syscall_vserver                   236
    define syscall_mbind                     237
    define syscall_set_mempolicy             238
    define syscall_get_mempolicy             239
    define syscall_mq_open                   240
    define syscall_mq_unlink                 241
    define syscall_mq_timedsend              242
    define syscall_mq_timedreceive           243
    define syscall_mq_notify                 244
    define syscall_mq_getsetattr             245
    define syscall_kexec_load                246
    define syscall_waitid                    247
    define syscall_add_key                   248
    define syscall_request_key               249
    define syscall_keyctl                    250
    define syscall_ioprio_set                251
    define syscall_ioprio_get                252
    define syscall_inotify_init              253
    define syscall_inotify_add_watch         254
    define syscall_inotify_rm_watch          255
    define syscall_migrate_pages             256
    define syscall_openat                    257
    define syscall_mkdirat                   258
    define syscall_mknodat                   259
    define syscall_fchownat                  260
    define syscall_futimesat                 261
    define syscall_newfstatat                262
    define syscall_unlinkat                  263
    define syscall_renameat                  264
    define syscall_linkat                    265
    define syscall_symlinkat                 266
    define syscall_readlinkat                267
    define syscall_fchmodat                  268
    define syscall_faccessat                 269
    define syscall_pselect6                  270
    define syscall_ppoll                     271
    define syscall_unshare                   272
    define syscall_set_robust_list           273
    define syscall_get_robust_list           274
    define syscall_splice                    275
    define syscall_tee                       276
    define syscall_sync_file_range           277
    define syscall_vmsplice                  278
    define syscall_move_pages                279
    define syscall_utimensat                 280
    define syscall_epoll_pwait               281
    define syscall_signalfd                  282
    define syscall_timerfd_create            283
    define syscall_eventfd                   284
    define syscall_fallocate                 285
    define syscall_timerfd_settime           286
    define syscall_timerfd_gettime           287
    define syscall_accept4                   288
    define syscall_signalfd4                 289
    define syscall_eventfd2                  290
    define syscall_epoll_create1             291
    define syscall_dup3                      292
    define syscall_pipe2                     293
    define syscall_inotify_init1             294
    define syscall_preadv                    295
    define syscall_pwritev                   296
    define syscall_rt_tgsigqueueinfo         297
    define syscall_perf_event_open           298
    define syscall_recvmmsg                  299
    define syscall_fanotify_init             300
    define syscall_fanotify_mark             301
    define syscall_prlimit64                 302
    define syscall_name_to_handle_at         303
    define syscall_open_by_handle_at         304
    define syscall_clock_adjtime             305
    define syscall_syncfs                    306
    define syscall_sendmmsg                  307
    define syscall_setns                     308
    define syscall_getcpu                    309
    define syscall_process_vm_readv          310
    define syscall_process_vm_writev         311
    define syscall_kcmp                      312
    define syscall_finit_module              313
    #+end_src
*** about open & read & write
    #+begin_src fasm :tangle 1st-instar.fasm
    STDIN  = 0
    STDOUT = 1
    STDERR = 2

    open_read         = 0
    open_write        = 1
    open_readAndWrite = 2

    open_creat      = 0100o
    open_rewrite    = 1000o ;; rewrite if file exist
    open_append     = 2000o

    open_excl       = 0200o ;; ensure that THIS call creates the file
    open_noctty     = 0400o
    open_nonblock   = 4000o
    open_nondelay   = open_nonblock
    open_sync       = 10000o
    open_async      = 20000o
    open_direct     = 40000o
        ;; to minimize cache effects of the I/O to and from this file.

    open_largefile  = 100000o
    open_directory  = 200000o
    open_nofollow   = 400000o ;; If pathname is a symbolic link, then the open fails.



    ;; fetch from /usr/include/unistd.h
    ;; lseek is for to make reposition read/write file offset
    ;; seek_set       the offset is set to offset bytes
    ;; seek_current   the offset is set to its current location plus offset bytes
    ;; seek_end       the offset is set to the size of the file plus offset bytes
    define seek_set       0 ;; seek from beginning of file
    define seek_current   1 ;; seek from current position
    define seek_end       2 ;; seek from end of file
    define seek_data      3 ;; seek to next data
    define seek_hole      4 ;; seek to next hole
    #+end_src
** format header
   #+begin_src fasm :tangle 1st-instar.fasm
   format elf64 executable 3
   #+end_src
** entry
   #+begin_src fasm :tangle 1st-instar.fasm
   entry begin_to_interpret_threaded_code
   segment readable executable writeable
   #+end_src
* -----------------------------------
* macro
** misc
   #+begin_src fasm :tangle 1st-instar.fasm
   ;; in fasm, "dup" is a reserved word
   dup equ duplicate
   #+end_src
** bead_size
   * 64-bits
   #+begin_src fasm :tangle 1st-instar.fasm
   bead_size = 8 ;; (byte)
   xx equ dq
   #+end_src
** argument_stack & return_stack
   * when doing "push"
     a stack-pointer moves to lower address
   * note that another style is that
     when doing "push"
     a stack-pointer moves to higher address
   * the stack-pointer
     always stores the address of current-free-address of the stack
   * note that another style is that
     under the stack-pointer
     there always stores the value of the-top-of-the-stack
   #+begin_src fasm :tangle 1st-instar.fasm
   ;; if you want to extend cicada in assembly,
   ;; the following registers must not be used
   ;; =================================
   define pointer$argument_stack   r15
   define pointer$return_stack     r14
   ;; =================================

   macro push_argument_stack register {
      mov [pointer$argument_stack], register
      add pointer$argument_stack, bead_size
      }
   macro pop_argument_stack register {
      sub pointer$argument_stack, bead_size
      mov register, [pointer$argument_stack]
      }

   macro push_return_stack register {
      mov [pointer$return_stack], register
      add pointer$return_stack, bead_size
      }
   macro pop_return_stack register {
      sub pointer$return_stack, bead_size
      mov register, [pointer$return_stack]
      }
   #+end_src
** memory allocation in un_initialized_memory
   * implemented as a memory map
   #+begin_src fasm :tangle 1st-instar.fasm
   current_free_address$un_initialized_memory = address$un_initialized_memory

   labeling  equ = current_free_address$un_initialized_memory
   preserve  equ current_free_address$un_initialized_memory = current_free_address$un_initialized_memory +
   #+end_src
** current_free_address$primitive_string_heap
   #+begin_src fasm :tangle 1st-instar.fasm
   current_free_address$primitive_string_heap = address$primitive_string_heap
   #+end_src
** exit
   #+begin_src fasm :tangle 1st-instar.fasm
   exit = 0
   #+end_src
** next
   #+begin_src fasm :tangle 1st-instar.fasm
   macro next {
      ;; 1. 移動 return_stack 中的第一串珠珠一次
      ;; 2. 如果 遇到珠珠的末尾
      ;;         把這串珠珠抽出
      ;;    否則 不抽出
      ;; 3. 去尋求被移出的一顆珠的意義
   local at_the_end_of_jojo
      pop_return_stack rbx
      mov rax, qword[rbx] ;; 記錄被移出的一顆珠
      add rbx, bead_size
      cmp dword[rbx], exit
      je at_the_end_of_jojo
      push_return_stack rbx ;; 把珠珠放回 就代表不抽出
   at_the_end_of_jojo:
      ;; 去尋求被移出的一顆珠的意義
      ;; 因爲 對其意義的詮釋方式 被記錄在其地址下
      ;; 所以需要一次 間接跳
      ;; 跳過去之後 rax 保存的是被移出的一顆珠
      jmp qword[rax]
      }
   #+end_src
** link
   #+begin_src fasm :tangle 1st-instar.fasm
   ;; initial link to point to 0 (as null)
   link = 0
   #+end_src
** JO_TYPE encoding
   #+begin_src fasm :tangle 1st-instar.fasm
   JO_TYPE__function = 0
   JO_TYPE__primitive_function = 1
   JO_TYPE__variable = 2
   #+end_src
** make_name_string
   * 2 bytes for length of name_string
   * note that
     the following is using local label
   #+begin_src fasm :tangle 1st-instar.fasm
   macro make_name_string string {

   virtual at 0
   .start$string:
      db string
   .end$string:
      dd (.end$string - .start$string)
      load .length word from (.end$string)
   end virtual
   store word .length at (current_free_address$primitive_string_heap)

   current_free_address$primitive_string_heap = current_free_address$primitive_string_heap + 2

   repeat .length
     virtual at 0
        db string
        load .char byte from (% - 1)
     end virtual
     store byte .char at (current_free_address$primitive_string_heap)
     current_free_address$primitive_string_heap = current_free_address$primitive_string_heap + 1
   end repeat

   }
   #+end_src
** define_function
   #+begin_src fasm :tangle 1st-instar.fasm
   macro define_function string, jo {

   define_function__#jo:

   name__#jo:
      xx current_free_address$primitive_string_heap

      make_name_string string

   link__#jo:
      xx link
      link = link__#jo

   type__#jo:
      xx JO_TYPE__function

   jo:
      xx explain$function

      ;; 後面跟着作爲 function 的函數體的一串珠珠

      }
   #+end_src
** define_primitive_function
   #+begin_src fasm :tangle 1st-instar.fasm
   macro define_primitive_function string, jo {

   define_primitive_function__#jo:

   name__#jo:
      xx current_free_address$primitive_string_heap

      make_name_string string

   link__#jo:
      xx link
      link = link__#jo

   type__#jo:
      xx JO_TYPE__primitive_function

   jo:
      xx assembly_code__#jo

   assembly_code__#jo:
      ;; 後面跟着作爲 primitive_function 的函數體的匯編代碼

      }
   #+end_src
** define_variable
   * no constant
     only variable
   * when a variable jo in the jojo
     it push the value of the variable to argument_stack
   * when wish to change a variable's value
     use key_word "address" to get the address of the variable
   #+begin_src fasm :tangle 1st-instar.fasm
   macro define_variable string, jo {

   define_variable__#jo:

   name__#jo:
      xx current_free_address$primitive_string_heap

      make_name_string string

   link__#jo:
      xx link
      link = link__#jo

   type__#jo:
      xx JO_TYPE__primitive_function

   jo:
      xx explain$variable

      ;; 後面跟着作爲 全局變元之值的 bead_size 大小的數值
      ;; 只能有一個值

      }
   #+end_src
* -----------------------------------
* primitive_string_heap
  #+begin_src fasm :tangle 1st-instar.fasm
  size$primitive_string_heap = 100 * 1024 ;; (byte)
  address$primitive_string_heap:
     times size$primitive_string_heap db 0
  #+end_src
* jo
** note explain
   * 尋求珠之意義
   * 注意
     每次經由 next 間接跳
     到這裏的詮釋者的時候
     rax 都保存着珠的值
     所以 rax 這個寄存器會被作爲某些詮釋者的參數
** explain$function
   * 把由這個 function 類型的 珠
     所找到的 一串珠珠 入 return_stack
   * a jojo can not be of size 0 or 1
   * use rax as an argument
     which stores a jo
   #+begin_src fasm :tangle 1st-instar.fasm
   explain$function:
      add rax, bead_size
      push_return_stack rax
      next
   #+end_src
** explain$variable
   #+begin_src fasm :tangle 1st-instar.fasm
   explain$variable:
      add rax, bead_size
      mov rbx, [rax]
      push_argument_stack rbx
      next
   #+end_src
* begin_to_interpret_threaded_code
  #+begin_src fasm :tangle 1st-instar.fasm
  begin_to_interpret_threaded_code:

     cld ;; set DF = 0, then rsi and rdi are incremented

     mov pointer$argument_stack,  address$argument_stack
     mov pointer$return_stack,    address$return_stack

     mov rax, first_jojo
     push_return_stack rax
     next

  first_jojo:
     xx little_test
  #+end_src
* argument_stack
** memory allocation
   #+begin_src fasm :tangle 1st-instar.fasm
   address$argument_stack labeling
      preserve 1024 * 1024 * bead_size
   #+end_src
* return_stack
** memory allocation
   #+begin_src fasm :tangle 1st-instar.fasm
   address$return_stack labeling
      preserve 1024 * 1024 * bead_size
   #+end_src
* little_test
  #+begin_src fasm :tangle 1st-instar.fasm
  define_function "little_test", little_test
    xx V__ak
    xx exit_with_TOS
    xx exit

  define_variable "47", V__ak
    xx 47

  define_primitive_function "exit-with-TOS", exit_with_TOS
      pop_argument_stack sys_1_rdi
      mov sys_n_rax, syscall_exit
      syscall
  #+end_src
* -----------------------------------
* epilog
** un_initialized_memory
   #+begin_src fasm :tangle 1st-instar.fasm
   size$un_initialized_memory = 64 * 1024 * 1024 ;; (byte)

   segment readable writeable
   address$un_initialized_memory:
       rb size$un_initialized_memory
   #+end_src
* ===================================
